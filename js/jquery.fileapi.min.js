!function(e,t){"use strict";var i=e.noop,s=!e.fn.prop,o=s?"attr":"prop",r=s?"removeAttr":"removeProp",n=[].slice,l=t.each,a=t.extend,h=function(e,t){var i=n.call(arguments,2);return t.bind?t.bind.apply(t,[e].concat(i)):function(){return t.apply(e,i.concat(n.call(arguments)))}},p=function(e){return'[data-fileapi="'+e+'"]'},f=function(e){return 0===e.indexOf("#")},u=function(t,s){if(this.$el=t=e(t).on("change.fileapi",'input[type="file"]',h(this,this._onSelect)),this.el=t[0],this._options={},this.options={url:0,data:{},accept:0,multiple:!1,paramName:0,dataType:"json",duplicate:!1,uploadRetry:0,networkDownRetryTimeout:5e3,chunkSize:0,chunkUploadRetry:3,chunkNetworkDownRetryTimeout:2e3,maxSize:0,maxFiles:0,imageSize:0,sortFn:0,filterFn:0,autoUpload:!1,clearOnSelect:void 0,clearOnComplete:void 0,lang:{B:"bytes",KB:"KB",MB:"MB",GB:"GB",TB:"TB"},sizeFormat:"0.00",imageOriginal:!0,imageTransform:0,imageAutoOrientation:!!FileAPI.support.exif,elements:{ctrl:{upload:p("ctrl.upload"),reset:p("ctrl.reset"),reload:p("ctrl.reload"),abort:p("ctrl.abort")},empty:{show:p("empty.show"),hide:p("empty.hide")},emptyQueue:{show:p("emptyQueue.show"),hide:p("emptyQueue.hide")},active:{show:p("active.show"),hide:p("active.hide")},size:p("size"),name:p("name"),progress:p("progress"),list:p("list"),file:{tpl:p("file.tpl"),progress:p("file.progress"),active:{show:p("file.active.show"),hide:p("file.active.hide")},preview:{el:0,get:0,width:0,height:0,processing:0},abort:p("file.abort"),remove:p("file.remove"),rotate:p("file.rotate")},dnd:{el:p("dnd"),hover:"dnd_hover",fallback:p("dnd.fallback")}},onDrop:i,onDropHover:i,onSelect:i,onBeforeUpload:i,onUpload:i,onProgress:i,onComplete:i,onReload:i,onFilePrepare:i,onFileUpload:i,onFileProgress:i,onFileComplete:i,onFileRemove:null,onFileRemoveCompleted:null},e.extend(!0,this.options,s),s=this.options,this.option("elements.file.preview.rotate",s.imageAutoOrientation),!s.url){var o=this.$el.attr("action")||this.$el.find("form").attr("action");o?s.url=o:this._throw("url â€” is not defined")}this.$files=this.$elem("list"),this.$fileTpl=this.$elem("file.tpl"),this.itemTplFn=e.fn.fileapi.tpl(e("<div/>").append(this.$elem("file.tpl")).html()),l(s,function(e,t){this._setOption(t,e)},this),this.$el.on("reset.fileapi",h(this,this._onReset)).on("reload.fileapi",h(this,this._onReload)).on("submit.fileapi",h(this,this._onSubmit)).on("upload.fileapi progress.fileapi complete.fileapi",h(this,this._onUploadEvent)).on("fileupload.fileapi fileprogress.fileapi filecomplete.fileapi",h(this,this._onFileUploadEvent)).on("click","[data-fileapi]",h(this,this._onActionClick));var r=s.elements.ctrl;r&&(this._listen("click",r.reset,h(this,this._onReset)),this._listen("click",r.upload,h(this,this._onSubmit)),this._listen("click",r.reload,h(this,this._onReload)),this._listen("click",r.abort,h(this,this._onAbort)));var n=FileAPI.support.dnd;this.$elem("dnd.el",!0).toggle(n),this.$elem("dnd.fallback").toggle(!n),n&&this.$elem("dnd.el",!0).dnd(h(this,this._onDropHover),h(this,this._onDrop)),this.$progress=this.$elem("progress"),void 0===s.clearOnSelect&&(s.clearOnSelect=!s.multiple),this.clear(),e.isArray(s.files)&&(this.files=e.map(s.files,function(t){return"string"===e.type(t)&&(t={src:t,size:0}),t.name=t.name||t.src.split("/").pop(),t.type=t.type||/\.(jpe?g|png|bmp|gif|tiff?)/i.test(t.src)&&"image/"+t.src.split(".").pop(),t.complete=!0,t}),this._redraw())};function c(e,t,i,s){if(i&&s){var o=(i>0?i:i[t])-(s>0?s:s[t.substr(3).toLowerCase()]),r=/max/.test(t);(r&&o<0||!r&&o>0)&&(e.errors||(e.errors={}),e.errors[t]=Math.abs(o))}}function d(e,t,i,s){if(e){var o=i.length-(e-t);o>0&&l(i.splice(0,o),function(e,t){c(e,"maxFiles",-1,t),s.push(e)})}}u.prototype={constructor:u,_throw:function(e){throw"jquery.fileapi: "+e},_getFiles:function(e,i){var s=this.options,o=s.maxSize,r=s.maxFiles,n=s.filterFn,a=this.files.length,h=t.getFiles(e),p={all:h,files:[],other:[],duplicate:s.duplicate?[]:this._extractDuplicateFiles(h)},f=s.imageSize,u=this;f||n?t.filterFiles(h,function(e,t){return t&&f&&(c(e,"minWidth",f,t),c(e,"minHeight",f,t),c(e,"maxWidth",f,t),c(e,"maxHeight",f,t)),c(e,"maxSize",o,e.size),!e.errors&&(!n||n(e,t))},function(e,t){d(r,a,e,t),p.other=t,p.files=e,i.call(u,p)}):(l(h,function(e){c(e,"maxSize",o,e.size),p[e.errors?"other":"files"].push(e)}),d(r,a,p.files,p.other),i.call(u,p))},_extractDuplicateFiles:function(e){for(var t,i=[],s=e.length,o=this.files;s--;)for(t=o.length;t--;)if(this._fileCompare(e[s],o[t])){i.push(e.splice(s,1));break}return i},_fileCompare:function(e,t){return e.size==t.size&&e.name==t.name},_getFormatedSize:function(e){var i=this.options,s="B";return e>=t.TB?e/=t[s="TB"]:e>=t.GB?e/=t[s="GB"]:e>=t.MB?e/=t[s="MB"]:e>=t.KB&&(e/=t[s="KB"]),i.sizeFormat.replace(/^\d+([^\d]+)(\d*)/,function(t,o,r){return((e=(parseFloat(e)||0).toFixed(r.length))+"").replace(".",o)+" "+i.lang[s]})},_onReload:function(e){e.preventDefault(),this.reload()},_onSelect:function(e){this.options.clearOnSelect&&(this.queue=[],this.files=[]),this._getFiles(e,h(this,function(t){t.all.length&&!1!==this.emit("select",t)&&this.add(t.files),FileAPI.reset(e.target)}))},_onActionClick:function(t){var i=t.currentTarget,s=e.attr(i,"data-fileapi"),o=e(i).closest("[data-fileapi-id]",this.$el).attr("data-fileapi-id"),r=this._getFile(o),n=!0;this.$file(o).attr("disabled")||("file.remove"==s?r&&this.emit("fileRemove"+(r.complete?"Completed":""),r)&&this.remove(o):/^file\.rotate/.test(s)?this.rotate(o,/ccw/.test(s)?"-=90":"+=90"):n=!1),n&&t.preventDefault()},_listen:function(t,i,s){i&&l(e.trim(i).split(","),function(i){i=e.trim(i),f(i)?e(i).on(t+".fileapi",s):this.$el.on(t+".fileapi",i,s)},this)},_onSubmit:function(e){e.preventDefault(),this.upload()},_onReset:function(e){e.preventDefault(),this.clear(!0)},_onAbort:function(e){e.preventDefault(),this.abort()},_onDrop:function(e){this._getFiles(e,function(e){!1!==this.emit("drop",e)&&this.add(e.files)})},_onDropHover:function(t,i){if(!1!==this.emit("dropHover",{state:t,event:i})){var s=this.option("elements.dnd.hover");s&&e(i.currentTarget).toggleClass(s,t)}},_getFile:function(e){return t.filter(this.files,function(i){return t.uid(i)==e})[0]},_getUploadEvent:function(e,t){var i={xhr:e=this.xhr||e,file:this.xhr.currentFile,files:this.xhr.files,widget:this};return a(i,t)},_emitUploadEvent:function(e,t,i){var s=this._getUploadEvent(i);this.emit(e+"Upload",s)},_emitProgressEvent:function(e,t,i,s){var o=this._getUploadEvent(s,t);this.emit(e+"Progress",o)},_emitCompleteEvent:function(t,i,s,o){var r=this._getUploadEvent(s,{error:i,status:s.status,statusText:s.statusText,result:s.responseText});if("file"==t&&(o.complete=!0),"json"==this.options.dataType)try{r.result=e.parseJSON(r.result)}catch(i){r.error=i}this.emit(t+"Complete",r)},_onUploadEvent:function(e,t){var i=this,s=i.$progress,o=e.type;if("progress"==o)s.stop().animate({width:t.loaded/t.total*100+"%"},300);else if("upload"==o)s.width(0);else{var r=function(){s.dequeue(),i[i.options.clearOnComplete?"clear":"dequeue"]()};this.xhr=null,this.active=!1,s.length?s.queue(r):r()}},_onFileUploadPrepare:function(i,s){var o=t.uid(i),r=this._rotate[o],n=this._crop[o],h=this._resize[o],p=this._getUploadEvent(this.xhr);if(r||n||h){var f=e.extend(!0,{},s.imageTransform||{});r=null!=r?r:this.options.imageAutoOrientation?"auto":void 0,e.isEmptyObject(f)||function(e){var t;for(t in e)if(e.hasOwnProperty(t)&&!(e[t]instanceof Object||"overlay"===t))return!0;return!1}(f)?(a(f,h),f.crop=n,f.rotate=r):l(f,function(e){a(e,h),e.crop=n,e.rotate=r}),s.imageTransform=f}p.file=i,p.options=s,this.emit("filePrepare",p)},_onFileUploadEvent:function(e,i){var s=this,o=e.type.substr(4),r=t.uid(i.file),n=this.$file(r),l=this._$fileprogress,a=this.options;if(this.__fileId!==r&&(this.__fileId=r,this._$fileprogress=l=this.$elem("file.progress",n)),"progress"==o)l.stop().animate({width:i.loaded/i.total*100+"%"},300);else if("upload"==o||"complete"==o){var h=function(){var e="file."+o,t=s.$elem("file.remove",n);"upload"==o?(t.hide(),l.width(0)):a.onFileRemoveCompleted&&t.show(),l.dequeue(),s.$elem(e+".show",n).show(),s.$elem(e+".hide",n).hide()};l.length?l.queue(h):h(),"complete"==o&&(this.uploaded.push(i.file),delete this._rotate[r])}},_redraw:function(i,s){var r=this.files,n=!!this.active,a=!r.length&&!n,h=!this.queue.length&&!n,p=[],f=0,u=this.$files,c=u.children().length,d=this.option("elements.preview"),m=this.option("elements.file.preview");i&&this.$files.empty(),s&&d&&d.el&&!this.queue.length&&this.$(d.el).empty(),l(r,function(i,s){var o=t.uid(i);if(p.push(i.name),f+=i.complete?0:i.size,d&&d.el)this._makeFilePreview(o,i,d,!0);else if(u.length&&!this.$file(o).length){var r=this.itemTplFn({$idx:c+s,uid:o,name:i.name,type:i.type,size:i.size,complete:!!i.complete,sizeText:this._getFormatedSize(i.size)}),n=e(r).attr("data-fileapi-id",o);i.$el=n,u.append(n),i.complete&&(this.$elem("file.upload.hide",n).hide(),this.$elem("file.complete.hide",n).hide()),m.el&&this._makeFilePreview(o,i,m)}},this),this.$elem("name").text(p.join(", ")),this.$elem("size").text(h?"":this._getFormatedSize(f)),this.$elem("empty.show").toggle(a),this.$elem("empty.hide").toggle(!a),this.$elem("emptyQueue.show").toggle(h),this.$elem("emptyQueue.hide").toggle(!h),this.$elem("active.show").toggle(n),this.$elem("active.hide").toggle(!n),this.$(".js-fileapi-wrapper,:file")[n?"attr":"removeAttr"]("aria-disabled",n)[o]("disabled",n),this._disableElem("ctrl.upload",h||n),this._disableElem("ctrl.reset",h||n),this._disableElem("ctrl.reload",h||n),this._disableElem("ctrl.abort",!n)},_disableElem:function(e,t){this.$elem(e)[t?"attr":"removeAttr"]("aria-disabled","disabled")[o]("disabled",t)},_makeFilePreview:function(e,i,s,o){var r=this,n=o?r.$(s.el):r.$file(e).find(s.el);if(!r._crop[e])if(/^image/.test(i.type)){var l=t.Image(i.src||i),a=function(){l.get(function(t,o){r._crop[e]||(t?(s.get&&s.get(n,i),r.emit("previewError",[t,i])):n.html(o))})};s.width&&l.preview(s.width,s.height),s.rotate&&l.rotate("auto"),s.processing?s.processing(i,l,a):a()}else s.get&&s.get(n,i)},emit:function(t,i){var s,o=this.options,r=e.Event(t.toLowerCase());return r.widget=this,t=e.camelCase("on-"+t),e.isFunction(o[t])&&(s=o[t].call(this.el,r,i)),this.$el.triggerHandler(r,i),!1!==s&&!r.isDefaultPrevented()},add:function(e,t){if((e=[].concat(e)).length){var i=this.options.sortFn;i&&e.sort(i),this.xhr&&this.xhr.append(e),this.queue=t?e:this.queue.concat(e),this.files=t?e:this.files.concat(e),this.active?(this.xhr.append(e),this._redraw(t)):this.options.autoUpload&&this.upload()}},$:function(t,i){return"string"==typeof t&&(t=/^#/.test(t)?t:(i?e(i):this.$el).find(t)),e(t)},$elem:function(t,i,s){i&&i.jquery&&(s=i,i=!1);var o=this.option("elements."+t);return void 0===o&&i&&(o=this.option("elements."+t.substr(0,t.lastIndexOf(".")))),this.$("string"!=e.type(o)&&e.isEmptyObject(o)?[]:o,s)},$file:function(e){return this.$('[data-fileapi-id="'+e+'"]')},option:function(t,i){if(void 0!==i&&e.isPlainObject(i))return l(i,function(e,i){this.option(t+"."+i,e)},this),this;var s,o,r=this.options,n=r[t],a=0;if(-1!=t.indexOf("."))for(n=r,s=(t=t.split(".")).length;a<s;a++){if(o=t[a],void 0!==i&&s-a==1){n[o]=i;break}n[o]||(n[o]={}),n=n[o]}else void 0!==i&&(r[t]=i);return void 0!==i&&(this._setOption(t,i,this._options[t]),this._options[t]=i),void 0!==i?i:n},_setOption:function(e,t){switch(e){case"accept":case"multiple":this.$(":file")[t?o:r](e,t);break;case"paramName":t&&this.$(":file")[o]("name",t)}},serialize:function(){var t,i={};return this.$el.find(":input").each(function(s,o){(s=o.name)&&!o.disabled&&(o.checked||/select|textarea|input/i.test(o.nodeName)&&!/checkbox|radio|file/i.test(o.type))&&(t=e(o).val(),void 0!==i[s]?(i[s].push||(i[s]=[i[s]]),i[s].push(t)):i[s]=t)}),i},upload:function(){if(!this.active&&this.emit("beforeUpload",{widget:this,files:this.queue})){this.active=!0;var e=this.$el,i=this.options,s={},o={url:i.url,data:a({},this.serialize(),i.data),headers:i.headers,files:s,uploadRetry:i.uploadRetry,networkDownRetryTimeout:i.networkDownRetryTimeout,chunkSize:i.chunkSize,chunkUploadRetry:i.chunkUploadRetry,chunkNetworkDownRetryTimeout:i.chunkNetworkDownRetryTimeout,prepare:h(this,this._onFileUploadPrepare),imageOriginal:i.imageOriginal,imageTransform:i.imageTransform,imageAutoOrientation:i.imageAutoOrientation};s[e.find(":file").attr("name")||"files[]"]=this.queue,l(["Upload","Progress","Complete"],function(e){var t=e.toLowerCase();o[t]=h(this,this["_emit"+e+"Event"],""),o["file"+t]=h(this,this["_emit"+e+"Event"],"file")},this),this.xhr=t.upload(o),this._redraw()}},reload:function(){var t=this.options;this.clear(),e.isArray(t.files)&&(this.files=e.map(t.files,function(t){return"string"===e.type(t)&&(t={src:t,size:0}),t.name=t.name||t.src.split("/").pop(),t.type=t.type||/\.(jpe?g|png|bmp|gif|tiff?)/i.test(t.src)&&"image/"+t.src.split(".").pop(),t.complete=!0,t}),this._redraw())},abort:function(e){this.active&&this.xhr&&this.xhr.abort(e)},crop:function(i,s){var o=t.uid(i),r=this.options,n=r.multiple?this.option("elements.file.preview"):r.elements.preview,l=(r.multiple?this.$file(o):this.$el).find(n&&n.el);l.length&&t.getInfo(i,h(this,function(o,a){if(o)this.emit("previewError",[o,i]);else{l.find("div>div").length||l.html(e("<div><div></div></div>").css(n).css("overflow","hidden")),this.__cropFile!==i&&(this.__cropFile=i,t.Image(i).rotate(r.imageAutoOrientation?"auto":0).get(function(t,i){l.find(">div>div").html(e(i).width("100%").height("100%"))},"exactFit"));var h=n.width,p=n.height,f=h,u=p,c=h/s.rw,d=p/s.rh;n.keepAspectRatio&&(c>1&&d>1?(c=d=1,u=s.h,f=s.w):c<d?(d=c,u=h*s.rh/s.rw):(c=d,f=p*s.rw/s.rh)),l.find(">div>div").css({width:Math.round(c*a[s.flip?"height":"width"]),height:Math.round(d*a[s.flip?"width":"height"]),marginLeft:-Math.round(c*s.rx),marginTop:-Math.round(d*s.ry)}),n.keepAspectRatio&&l.find(">div").css({width:Math.round(f),height:Math.round(u),marginLeft:f<h?Math.round((h-f)/2):0,marginTop:u<p?Math.round((p-u)/2):0})}})),this._crop[o]=s},resize:function(e,i,s,o){this._resize[t.uid(e)]={type:o,width:i,height:s}},rotate:function(i,s){var o="string"==e.type(i)?i:t.uid(i),r=this.options,n=r.multiple?this.option("elements.file.preview"):r.elements.preview,l=(r.multiple?this.$file(o):this.$el).find(n&&n.el),a=this._rotate;i=this._getFile(o),t.getInfo(i,function(e,n){var h=n&&n.exif&&n.exif.Orientation,p=r.imageAutoOrientation&&t.Image.exifOrientation[h]||0;null==a[o]&&(a[o]=p||0),/([+-])=/.test(s)?a[o]=s=a[o]+("+"==RegExp.$1?1:-1)*s.substr(2):a[o]=s,i.rotate=s,s-=p,l.css({"-webkit-transform":"rotate("+s+"deg)","-moz-transform":"rotate("+s+"deg)",transform:"rotate("+s+"deg)"})})},remove:function(e){var i="object"==typeof e?t.uid(e):e;this.$file(i).remove(),this.queue=t.filter(this.queue,function(e){return t.uid(e)!=i}),this.files=t.filter(this.files,function(e){return t.uid(e)!=i}),this._redraw()},clear:function(e){this._crop={},this._resize={},this._rotate={},this.queue=[],this.files=[],this.uploaded=[],e=void 0===e||e,this._redraw(e,e)},dequeue:function(){this.queue=[],this._redraw()},widget:function(){return this},toString:function(){return"[jQuery.FileAPI object]"},destroy:function(){this.$files.empty().append(this.$fileTpl),this.$el.off(".fileapi").removeData("fileapi"),l(this.options.elements.ctrl,function(t){f(t)&&e(t).off("click.fileapi")})}},e.fn.fileapi=function(t,i){var s=this.data("fileapi");if(s){if("widget"===t)return s;if("string"==typeof t){var o,r=s[t];return e.isFunction(r)?o=r.apply(s,n.call(arguments,1)):void 0===r?o=s.option(t,i):"files"===t&&(o=r),void 0===o?this:o}}else null!=t&&"object"!=typeof t||this.data("fileapi",new u(this,t));return this},e.fn.fileapi.version="0.4.11",e.fn.fileapi.tpl=function(e){var t=0,i="__b+='";return e.replace(/(?:&lt;|<)%([-=])?([\s\S]+?)%(?:&gt;|>)|$/g,function(s,o,r,n){return i+=e.slice(t,n).replace(/[\r\n"']/g,function(e){return"\\"+e}),r&&(i+=o?"'+\n((__x=("+r+"))==null?'':"+("-"==o?"__esc(__x)":"__x")+")\n+'":"';\n"+r+"\n__b+='"),t=n+s.length,s}),new Function("ctx","var __x,__b='',__esc=function(val){return typeof val=='string'?val.replace(/</g,'&lt;').replace(/\"/g,'&quot;'):val;};with(ctx||{}){\n"+i+"';\n}return __b;")},e.fn.webcam=function(s){var o=this,r=o,n=e(o),l="fileapi-camera",h=n.data(l);return!0===h?(t.log("[webcam.warn] not ready."),r=null):"widget"===s?r=h:"destroy"===s?(h.stop(),n.empty()):h?r=h[s]():!1===h?(t.log("[webcam.error] does not work."),r=null):(n.data(l,!0),s=a({success:i,error:i},s),FileAPI.Camera.publish(n,s,function(e,t){n.data(l,!e&&t),s[e?"error":"success"].call(o,e||t)})),r},e.fn.cropper=function(i){var s=this,o=i.file;if("string"==typeof i)s.first().Jcrop.apply(s,arguments);else{var r=i.minSize||[0,0],n=i.aspectRatio||r[0]/r[1];e.isArray(i.minSize)&&void 0===i.aspectRatio&&n>0&&(i.aspectRatio=n),t.getInfo(o,function(a,h){var p=t.Image(o),f=i.maxSize,u=o.rotate;f&&p.resize(Math.max(f[0],r[0]),Math.max(f[1],r[1]),"max"),p.rotate(void 0===u?"auto":u).get(function(t,o){var r=i.selection,a=Math.min(o.width,o.height),p=a,f=a/n,u=FileAPI.Image.exifOrientation[h.exif&&h.exif.Orientation]||0;if(r){(/%/.test(r)||r>0&&r<1)&&(p*=r=parseFloat(r,10)/(r>0?1:100),f*=r);var c=(o.width-p)/2,d=(o.height-f)/2;i.setSelect=[0|c,0|d,c+p|0,d+f|0]}l(["onSelect","onChange"],function(e,t){(t=i[e])&&(i[e]=function(e){var i=u%180,s=h.width,r=h.height,n=e.x/o.width,l=e.y/o.height,a=e.w/o.width,p=e.h/o.height,f=s*(i?l:n),c=r*(i?1-(e.x+e.w)/o.width:l);t({x:f,y:c,w:s*(i?p:a),h:r*(i?a:p),rx:n*(i?r:s),ry:l*(i?s:r),rw:a*(i?r:s),rh:p*(i?s:r),lx:e.x,ly:e.y,lw:e.w,lh:e.h,lx2:e.x2,ly2:e.y2,deg:u,flip:i})})});var m=e("<div/>").css("lineHeight",0).append(e(o).css("margin",0));s.html(m),m.Jcrop(i).trigger("resize")})})}return s}}(jQuery,FileAPI);